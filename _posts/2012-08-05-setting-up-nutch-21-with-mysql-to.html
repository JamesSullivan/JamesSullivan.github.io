---
layout: post
title: Setting up Nutch 2.1 with MySQL to handle UTF-8
date: '2012-08-05T14:11:00.000-07:00'
categories: programming
author: Sully
tags:
- Java
- Chinese
- Ubuntu
- programming
- search
- Korean
- utf8
- Japanese
- Databases
- Nutch
modified_time: '2023-01-11T05:26:42.976-08:00'
blogger_id: tag:blogger.com,1999:blog-7835395644559909128.post-8251760414932240570
blogger_orig_url: http://blog.solutions.asia/2012/08/setting-up-nutch-21-with-mysql-to.html
---

These instructions assume Ubuntu 12.04 and <a href="http://blog.manishchhabra.com/2012/05/installing-oracle-sun-java-jdk-and-setting-java_home-in-ubuntu-linux/">Java 6 or 7 installed and JAVA_HOME configured</a>.<br /><br /><strong>Install MySQL Server and MySQL Client</strong> using the Ubuntu software center or <code>sudo apt-get install mysql-server mysql-client</code> at the command line.<br /><br />As MySQL defaults to latin (are we still in the 1990s?) we need to edit <code>sudo vi /etc/mysql/my.cnf</code> and under [mysqld] add<br /><br />innodb_file_format=barracuda<br />innodb_file_per_table=true<br />innodb_large_prefix=true<br />character-set-server=utf8mb4<br />collation-server=utf8mb4_unicode_ci<br />max_allowed_packet=500M<br /><br />The innodb options are to help deal with the small primary key size restriction of MySQL. Restart your machine for the changes to take effect. The max_allowed_packet option is so you don't run into issues as your database and the pages you store in it get larger.<br /><br />Check to make sure MySQL is running by typing <code>sudo netstat -tap | grep mysql</code>&nbsp; and you should see something like<br /><br />tcp&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0 localhost:mysql&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; *:*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; LISTEN<br /><br />We need to set up the nutch database manually as the current Nutch/Gora/MySQL generated db schema defaults to latin. Log into mysql at the command line using your previously set up MySQL id and password type<br /><br /><code>mysql -u xxxxx -p</code><br /><br />then in the MySQL editor type the following:<br /><br /><code>CREATE DATABASE nutch DEFAULT CHARACTER SET utf8mb4 DEFAULT COLLATE utf8mb4_unicode_ci;</code><br /><br />and enter followed by<br /><br /><code>use nutch;</code><br /><br />and enter and then copy and paste the following altogether:<br /><br /><code>CREATE TABLE `webpage` (<br />`id` varchar(767) NOT NULL,<br />`headers` blob,<br />`text` mediumtext DEFAULT NULL,<br />`status` int(11) DEFAULT NULL,<br />`markers` blob,<br />`parseStatus` blob,<br />`modifiedTime` bigint(20) DEFAULT NULL,<br />`score` float DEFAULT NULL,<br />`typ` varchar(32) CHARACTER SET latin1 DEFAULT NULL,<br />`baseUrl` varchar(767) DEFAULT NULL,<br />`content` longblob,<br />`title` varchar(2048) DEFAULT NULL,<br />`reprUrl` varchar(767) DEFAULT NULL,<br />`fetchInterval` int(11) DEFAULT NULL,<br />`prevFetchTime` bigint(20) DEFAULT NULL,<br />`inlinks` mediumblob,<br />`prevSignature` blob,<br />`outlinks` mediumblob,<br />`fetchTime` bigint(20) DEFAULT NULL,<br />`retriesSinceFetch` int(11) DEFAULT NULL,<br />`protocolStatus` blob,<br />`signature` blob,<br />`metadata` blob,<br />PRIMARY KEY (`id`)<br />) ENGINE=InnoDB<br />ROW_FORMAT=COMPRESSED <br />DEFAULT CHARSET=utf8mb4;</code><br /><br />Then type enter. You are done setting up the MySQL database for Nutch.<br /><br />&nbsp;<br /><br /><strong>Set up Nutch 2.1</strong> by downloading the latest version from <a href="http://www.apache.org/dyn/closer.cgi/nutch/">http://www.apache.org/dyn/closer.cgi/nutch/</a>. Untar the contents of the file you just downloaded and going forward we will refer to this folder as ${APACHE_NUTCH_HOME}.<br /><br />From inside the nutch folder ensure the MySQL dependency for Nutch is available by editing the following in ${APACHE_NUTCH_HOME}/ivy/ivy.xml<br /><br />&lt;!-- Uncomment this to use MySQL as database with SQL as Gora store. --&gt;<br />&lt;dependency org="mysql" name="mysql-connector-java" rev="5.1.18" conf="*-&gt;default"/&gt;<br /><br /><a name='more'></a><br /><br />Edit the ${APACHE_NUTCH_HOME}/conf/gora.properties file either deleting or commenting out the Default SqlStore Properties using #. Then add the MySQL properties below replacing xxxxx with the user and password you set up when installing MySQL earlier.<br /><br />###############################<br /># MySQL properties&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; #<br />###############################<br />gora.sqlstore.jdbc.driver=com.mysql.jdbc.Driver<br />gora.sqlstore.jdbc.url=jdbc:mysql://localhost:3306/nutch?createDatabaseIfNotExist=true<br />gora.sqlstore.jdbc.user=xxxxx<br />gora.sqlstore.jdbc.password=xxxxx<br /><br />Edit the ${APACHE_NUTCH_HOME}/conf/gora-sql-mapping.xml file changing the length of the primarykey from 512 to 767 in both places.<br />&lt;primarykey column="id" length="767"/&gt;<br /><br />Configure ${APACHE_NUTCH_HOME}/conf/nutch-site.xml to put in a name in the value field under http.agent.name. It can be anything but cannot be left blank. Add additional languages if you want (I have added Japanese ja-jp below) and utf-8 as default as well. You must specify Sqlstore.<br /><br />&lt;property&gt;<br />&lt;name&gt;http.agent.name&lt;/name&gt;<br />&lt;value&gt;Your Nutch Spider&lt;/value&gt;<br />&lt;/property&gt;<br /><br />&lt;property&gt;<br />&lt;name&gt;http.accept.language&lt;/name&gt;<br />&lt;value&gt;ja-jp, en-us,en-gb,en;q=0.7,*;q=0.3&lt;/value&gt;<br />&lt;description&gt;Value of the "Accept-Language" request header field.<br />This allows selecting non-English language as default one to retrieve.<br />It is a useful setting for search engines build for certain national group.<br />&lt;/description&gt;<br />&lt;/property&gt;<br /><br />&lt;property&gt;<br />&lt;name&gt;parser.character.encoding.default&lt;/name&gt;<br />&lt;value&gt;utf-8&lt;/value&gt;<br />&lt;description&gt;The character encoding to fall back to when no other information<br />is available&lt;/description&gt;<br />&lt;/property&gt;<br /><br />&lt;property&gt;<br />&lt;name&gt;storage.data.store.class&lt;/name&gt;<br />&lt;value&gt;org.apache.gora.sql.store.SqlStore&lt;/value&gt;<br />&lt;description&gt;The Gora DataStore class for storing and retrieving data.<br />Currently the following stores are available: ....<br />&lt;/description&gt;<br />&lt;/property&gt;<br /><br />Install ant using the Ubuntu software center or <code>sudo apt-get install ant</code> at the command line.<br /><br />From the command line <code>cd</code> to your nutch folder type <code>ant runtime</code><br />This may take a few minutes to compile.<br /><br />&nbsp;<br /><br /><strong>Start your first crawl</strong> by typing the lines below at the terminal (replace 'http://nutch.apache.org/' with whatever site you want to crawl):<br /><code><br />cd ${APACHE_NUTCH_HOME}/runtime/local<br />mkdir -p urls<br />echo 'http://nutch.apache.org/' &gt; urls/seed.txt<br />bin/nutch crawl urls -depth 3 -topN 5<br /></code><br /><br />You can easily add more urls to search by hand in seed.txt if you want. For the crawl, <em>depth</em> is the number of rounds of generate/fetch/parse/update you want to do (not depth of links as you might think at first) and <em>topN</em> is the max number of links you want to actually parse each time. Note however Nutch keeps track of all links it encounters in the webpage table (it just limits the amount it actually parses to TopN so don't be surprised by seeing many more rows in the webpage table than you expect by limiting with TopN).<br /><br /><strong>Check your crawl results</strong> by looking at the webpage table in the nutch database.<br /><code><br />mysql -u xxxxx -p<br />use nutch;<br />SELECT * FROM nutch.webpage;</code><br /><br />You should see the results of your crawl (around 159 rows). It will be hard to read the columns so you may want to install MySQL Workbench via <code>sudo apt-get install mysql-workbench</code> and use that instead for viewing the data. You may also want to run the following SQL command <code>select * from webpage where status = 2;</code> to limit the rows in the webpage table to only urls that were actually parsed.<br /><br />&nbsp;<br /><br /><strong>Set up and index with Solr</strong> If you are using Nutch 2.1 at this time you are into the bleeding edge and probably want the <a href="http://lucene.apache.org/solr/mirrors-solr-latest-redir.html?">latest version of Solr 4.0</a> as well. Untar it to to $HOME/apache-solr-4.0.0-XXXX. This folder will be now referred to as ${APACHE_SOLR_HOME}.<br />Download&nbsp;<a href="http://nlp.solutions.asia/wp-content/uploads/2012/08/schema.xml" target="_blank" title="Schema for Nutch 2.1 and Solr 4.0">http://nlp.solutions.asia/wp-content/uploads/2012/08/schema.xml</a>&nbsp; and use it to replace ${APACHE_SOLR_HOME}/example/solr/collection1/conf/schema.xml.<br /><br />From the terminal start solr:<br /><code>cd ${APACHE_SOLR_HOME}/example<br />java -jar start.jar</code><br /><br />You can check this is running by opening <a href="http://localhost:8983/solr">http://localhost:8983/solr</a> in your web browser.<br /><br />Leave that terminal running and from a different terminal type the following:<br /><code>cd ${APACHE_NUTCH_HOME}/runtime/local/<br />bin/nutch solrindex http://127.0.0.1:8983/solr/ -reindex</code><br /><br />You can now run queries using Solr versus your crawled content. Open <a href="http://localhost:8983/solr/#/collection1/query" target="_blank" title="Solr Query Link">http://localhost:8983/solr/#/collection1/query</a> and assuming you have crawled nutch.apache.org in the input box titled "q" you can do a search by inputting text:nutch&nbsp;&nbsp;<br /><br />There remains a lot to configure to get a good web search going but you are at least started.